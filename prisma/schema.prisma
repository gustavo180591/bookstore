generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String              @id @default(cuid())
  email            String              @unique
  passwordHash     String
  role             Role                @default(CUSTOMER)
  documentType     DocumentTypeAR      @default(DNI)
  documentNumber   String              @unique @db.VarChar(20)
  firstName        String?             @db.VarChar(80)
  lastName         String?             @db.VarChar(80)
  phone            String?             @db.VarChar(30)
  acceptsMarketing Boolean             @default(false)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  addresses        Address[]
  budgets          Budget[]
  carts            Cart[]
  institutions     InstitutionMember[]
  orders           Order[]
  payments         Payment[]
  sessions         Session[]

  @@index([email])
  @@index([documentNumber])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Institution {
  id          String              @id @default(cuid())
  name        String
  cuit        String?             @db.VarChar(20)
  phone       String?             @db.VarChar(30)
  email       String?             @db.VarChar(120)
  addressId   String?             @unique
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  address     Address?            @relation("InstitutionAddress")
  budgets     Budget[]
  members     InstitutionMember[]
  schoolLists SchoolList[]

  @@index([name])
}

model InstitutionMember {
  id            String      @id @default(cuid())
  institutionId String
  userId        String
  roleLabel     String?     @db.VarChar(80)
  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([institutionId, userId])
}

model Address {
  id            String       @id @default(cuid())
  userId        String?
  institutionId String?      @unique @map("institution_id")
  orderId       String?      @unique @map("order_id")
  type          AddressType
  fullName      String
  phone         String?      @db.VarChar(30)
  street        String
  number        String?      @db.VarChar(10)
  floor         String?      @db.VarChar(10)
  apartment     String?      @db.VarChar(10)
  city          String
  province      ProvinceAR
  postalCode    String       @db.VarChar(10)
  extraInfo     String?      @db.VarChar(255)
  institution   Institution? @relation("InstitutionAddress", fields: [institutionId], references: [id])
  order         Order?       @relation("OrderAddress", fields: [orderId], references: [id])
  user          User?        @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([institutionId])
}

model Cart {
  id        String     @id @default(cuid())
  userId    String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]

  @@index([userId])
}

model CartItem {
  id        String  @id @default(cuid())
  cartId    String
  productId String
  quantity  Int     @default(1)
  cart      Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([cartId])
}

model Product {
  id          String           @id @default(cuid())
  name        String
  description String?
  price       Decimal          @db.Decimal(10, 2)
  stock       Int              @default(0)
  sku         String?          @unique
  category    String?
  imageUrl    String?
  isActive    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  cartItems   CartItem[]
  orderItems  OrderItem[]
  budgetItems BudgetItem[]
  schoolLists SchoolListItem[]
  bundleProducts BundleProduct[]

  @@index([name])
  @@index([category])
}

model Order {
  id                String          @id @default(cuid())
  userId            String
  status            OrderStatus     @default(CREADO)
  total             Decimal         @db.Decimal(10, 2)
  currency          Currency        @default(ARS)
  shippingAddressId String?         @unique
  shippingCarrier   ShippingCarrier @default(RETIRO_EN_LOCAL)
  shippingCost      Decimal         @default(0) @db.Decimal(10, 2)
  notes             String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  shippingAddress   Address?        @relation("OrderAddress")
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     OrderItem[]
  payments  Payment[]
  budgets   Budget[]        @relation("BudgetToOrder")
  coupons   OrderCoupon[]

  @@index([userId])
  @@index([status])
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  productId String
  quantity  Int
  price     Decimal @db.Decimal(10, 2)
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([orderId])
}

model Payment {
  id         String          @id @default(cuid())
  orderId    String
  userId     String
  amount     Decimal         @db.Decimal(10, 2)
  currency   Currency        @default(ARS)
  status     PaymentStatus   @default(PENDING)
  provider   PaymentProvider
  externalId String?
  paidAt     DateTime?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  order      Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user       User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([userId])
  @@index([status])
}

model Budget {
  id            String       @id @default(cuid())
  userId        String
  institutionId String?
  title         String
  description   String?
  total         Decimal      @default(0) @db.Decimal(10, 2)
  currency      Currency     @default(ARS)
  status        String       @default("PENDING")
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  institution   Institution? @relation(fields: [institutionId], references: [id])
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  items         BudgetItem[]
  orders        Order[]      @relation("BudgetToOrder")

  @@index([userId])
  @@index([institutionId])
}

model BudgetItem {
  id        String  @id @default(cuid())
  budgetId  String
  productId String
  quantity  Int
  price     Decimal @db.Decimal(10, 2)
  budget    Budget  @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([budgetId])
}

model SchoolList {
  id            String           @id @default(cuid())
  institutionId String
  name          String
  grade         String?
  year          Int
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  institution   Institution      @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  items         SchoolListItem[]

  @@index([institutionId])
}

model SchoolListItem {
  id           String     @id @default(cuid())
  schoolListId String
  productId    String
  quantity     Int
  notes        String?
  product      Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  schoolList   SchoolList @relation(fields: [schoolListId], references: [id], onDelete: Cascade)

  @@index([schoolListId])
}

enum Role {
  ADMIN
  MANAGER
  CUSTOMER
}

enum Currency {
  ARS
  USD
}

enum DocumentTypeAR {
  DNI
  CUIL
  CUIT
}

enum ProvinceAR {
  BUENOS_AIRES
  CATAMARCA
  CHACO
  CHUBUT
  CORDOBA
  CORRIENTES
  ENTRE_RIOS
  FORMOSA
  JUJUY
  LA_PAMPA
  LA_RIOJA
  MENDOZA
  MISIONES
  NEUQUEN
  RIO_NEGRO
  SALTA
  SAN_JUAN
  SAN_LUIS
  SANTA_CRUZ
  SANTA_FE
  SANTIAGO_DEL_ESTERO
  TIERRA_DEL_FUEGO
  TUCUMAN
  CABA
}

enum OrderStatus {
  CREADO
  PAGO_PENDIENTE
  PAGO_APROBADO
  PREPARANDO
  DESPACHADO
  ENTREGADO
  CANCELADO
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  PAID
  PARTIALLY_REFUNDED
  REFUNDED
  FAILED
  CANCELED
}

enum PaymentProvider {
  MERCADO_PAGO
  TRANSFERENCIA
}

enum ShippingCarrier {
  ANDREANI
  OCA
  CORREO_ARG
  MERCADO_ENVIOS
  RETIRO_EN_LOCAL
}

enum AddressType {
  BILLING
  SHIPPING
}

enum DiscountType {
  PERCENT
  FIXED_AMOUNT
  FREE_SHIPPING
}

model Bundle {
  id          String   @id @default(cuid())
  name        String
  description String?
  discountType DiscountType
  discountValue Decimal @db.Decimal(10, 2)
  products    BundleProduct[]
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([name])
}

model Coupon {
  id          String   @id @default(cuid())
  code        String   @unique
  discountType DiscountType
  discountValue Decimal @db.Decimal(10, 2)
  minOrderValue Decimal? @db.Decimal(10, 2)
  maxUses     Int?
  usedCount   Int      @default(0)
  expiresAt   DateTime?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  orders      OrderCoupon[]

  @@index([code])
}

model BundleProduct {
  id        String @id @default(cuid())
  bundleId  String
  productId String
  bundle    Bundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model OrderCoupon {
  id       String @id @default(cuid())
  orderId  String
  couponId String
  order    Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  coupon   Coupon @relation(fields: [couponId], references: [id], onDelete: Cascade)

  @@unique([orderId, couponId])
}
